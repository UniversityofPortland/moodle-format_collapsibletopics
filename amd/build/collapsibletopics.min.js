define(["jquery","core/log","core/str"],function(a,b,c){"use strict";var d=function(a,b,c){"local"==c?window.localStorage.setItem("sections-toggle-"+a,JSON.stringify(b)):"session"==c&&window.sessionStorage.setItem("sections-toggle-"+a,JSON.stringify(b))},e=function(a,b){var c;return"local"==b?c=window.localStorage.getItem("sections-toggle-"+a):"session"==b&&(c=window.sessionStorage.getItem("sections-toggle-"+a)),null===c?{}:JSON.parse(c)};return{init:function(f){b.debug("Format collapsibletopics AMD module initialized"),a(document).ready(function(a){var b,g,h=f.keepstateoversession;g=1==h?"local":"session",b=e(f.course,g),setTimeout(function(){for(var c in b)c="#collapse-"+parseInt(c),a(c).collapse("show");var d=a(".section.current a.sectiontoggle").attr("href");a(d).collapse("show")},50),a("body").on("click",".expandall",function(c){c.preventDefault();var e=c.target;a(e).removeClass("expandall").addClass("collapseall").html(M.util.get_string("collapseall","moodle")),a(".sectiontoggle").each(function(c){var e="#collapse-"+(c+1);a(e).collapse("show"),b.hasOwnProperty(c+1)||(b[c+1]="true",d(f.course,b,g))})}),a("body").on("click",".collapseall",function(c){c.preventDefault();var e=c.target;a(e).removeClass("collapseall").addClass("expandall").html(M.util.get_string("expandall","moodle")),a(".sectiontoggle").each(function(c){var e="#collapse-"+(c+1);a(e).collapse("hide"),b.hasOwnProperty(c+1)&&(delete b[c+1],d(f.course,b,g))})}),a("#nav-drawer div.media").on("click",function(b){var c=a(b.target).parent().parent().parent().attr("href");if(c.lastIndexOf("#section-")!=-1){var d=c.substring(c.lastIndexOf("-")+1),e="#collapse-"+d;a(e).collapse("show")}}),a(".collapse").on("show.bs.collapse",function(c){var e=a(c.target).attr("id"),h=e.substring(e.lastIndexOf("-")+1);b.hasOwnProperty(h)||(b[h]="true",d(f.course,b,g))}),a(".collapse").on("hide.bs.collapse",function(c){var e=a(c.target).attr("id"),h=e.substring(e.lastIndexOf("-")+1);b.hasOwnProperty(h)&&(delete b[h],d(f.course,b,g))}),a("body").on("click",".togglecompletion button",function(b){var d=b.target,e=a(d).parent().parent().children('input[name="completionstate"]').val(),f=a(d).closest("li.section"),g=a(f).find(".progress-bar"),h=parseInt(a(g).attr("aria-valuenow")),i=1==e?h+1:h-1,j=parseInt(a(g).attr("aria-valuemax")),k=Math.round(i/j*100);a(g).attr("aria-valuenow",i),a(g).attr("style","width: "+k+"%");var l=[{key:"progresstotal",component:"completion",param:{complete:i,total:j}}];c.get_strings(l).then(function(b){a(g).attr("data-original-title",b)})})})}}});